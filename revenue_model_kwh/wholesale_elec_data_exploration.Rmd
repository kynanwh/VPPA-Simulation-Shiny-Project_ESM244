---
title: "Wholesale Elec Data Exploration"
author: "Kynan Witters Hicks"
date: "January 20, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, message = FALSE}

library(tidyverse)
library(janitor)
library(lubridate)
library(dplyr)
library(tsibble)
library(forecast)
library(tseries)
library(xts)
library(plyr)
library(zoo)

```


###Wholesale Electricity Data Exploration

####CAISO Data Wrangle - 2018 Data Only

#####5-minute intervale data for three hubs: 
TH_NP15
TH_SP15
TH_ZP26

```{r get and format data, message=FALSE}

caiso <- read_csv("caiso_2018_original.csv")

#convert "Data" data from character to date/time

caiso$date <- as.POSIXct(caiso$date,
                         format="%m/%d/%Y %H:%M")

```

```{r filter date by hub}

caiso_sp15 <- caiso %>% 
  filter(hub == "TH_SP15")

caiso_np15 <- caiso %>%
  filter(hub == "TH_NP15")

caiso_zp26 <- caiso %>% 
  filter(hub == "TH_ZP26")
```

```{r fill caiso data gaps, message=FALSE}

#sp15 hub

hub1 <- rep("TH_SP15", each=8760)

caiso_sp15_nodup <- caiso_sp15[!duplicated(caiso_sp15$date,
                                 by = c("date","hub")),]

caiso_sp15_clean <- caiso_sp15_nodup %>%
  as_tsibble(key = id(hub), index = date) %>% 
  fill_gaps(price = median(price)) %>% 
  index_by(datetime = floor_date(date, "hour")) %>% 
  summarise(price = mean(price))

caiso_sp15_clean2 <- data.frame(caiso_sp15_clean, hub1) %>% 
  rename(hub = hub1)
  
#np15 hub

hub2 <- rep("TH_NP15", each=8760)

caiso_np15_nodup <- caiso_np15[!duplicated(caiso_np15$date,
                                 by = c("date","hub")),]

caiso_np15_clean <- caiso_np15_nodup %>%
  as_tsibble(key = id(hub), index = date) %>% 
  fill_gaps(price = median(price)) %>% 
  index_by(datetime = floor_date(date, "hour")) %>% 
  summarise(price = mean(price))

caiso_np15_clean2 <- data.frame(caiso_np15_clean, hub2) %>% 
  rename(hub = hub2)

#zp26 hub

hub3 <- rep("TH_ZP26", each=8760)

caiso_zp26_nodup <- caiso_zp26[!duplicated(caiso_zp26$date,
                                 by = c("date","hub")),]

caiso_zp26_clean <- caiso_zp26_nodup %>%
  as_tsibble(key = id(hub), index = date) %>% 
  fill_gaps(price = median(price)) %>% 
  index_by(datetime = floor_date(date, "hour")) %>% 
  summarise(price = mean(price))

caiso_zp26_clean2 <- data.frame(caiso_zp26_clean, hub3) %>% 
  rename(hub = hub3)

#caiso_whole

caiso_nm <- rep("caiso", each = 26280)

caiso_bind <- rbind(caiso_np15_clean2, caiso_sp15_clean2, caiso_zp26_clean2)
caiso_clean <- data.frame(caiso_bind, caiso_nm) %>% 
  rename(iso = caiso_nm)

```

```{r export caiso hourly data}

write.csv(caiso_clean, "caiso_2018_hourly_byhub.csv")

```

```{r combine hubs, message = FALSE}

caiso_single <- read_csv("caiso_hourly.csv") %>% 
  dplyr::group_by(datetime) %>% 
  dplyr::summarise(
    mean(price)
  ) %>% 
  dplyr::rename(price = "mean(price)")

write.csv(caiso_single, "caiso_2018_hourly_avghubs.csv")

```

####CAISO Data Wrangle - 2015 - 2018 Data

```{r get and format data, message=FALSE}

caiso_4yr <- read_csv("caiso_2015-2018_original.csv")

#convert "Data" data from character to date/time

caiso_4yr$date <- as.POSIXct(caiso_4yr$date,
                         format="%m/%d/%Y %H:%M")

```

```{r fill caiso data gaps, message=FALSE}

#Remove NA Values
caiso_na <- which(is.na(caiso_4yr$date), arr.ind=TRUE)
caiso_nna <- caiso_4yr[-c(caiso_na),]

caiso_hr <- caiso_nna %>% 
  dplyr::group_by(Date = floor_date(date, "1 hour")) %>% 
  dplyr::summarise(
    mean(price)
  ) %>% 
  dplyr::rename(price = "mean(price)")

caiso_day <- caiso_nna %>% 
  dplyr::group_by(Date = floor_date(date, "1 day")) %>% 
  dplyr::summarise(
    mean(price)
  ) %>% 
  dplyr::rename(price = "mean(price)")

```


####Explore Timeseries Data 

```{r decompose hourly data 2015 - 2018, message = FALSE}

caiso_ts_hour <- ts(caiso_hr$price, frequency = 24, start = c(2015,1))

caiso_dc_hour <- decompose(caiso_ts_hour)
plot(caiso_dc_hour)

```

```{r decompose daily data 2015 - 2018, message=FALSE}

caiso_ts_day <- ts(caiso_day$price, frequency = 7, start = c(2015,1))

caiso_dc_day <- decompose(caiso_ts_day)
plot(caiso_dc_day)

```

```{r forecast daily data 2015 - 2018, message=FALSE}

caiso_day_pdq <- auto.arima(caiso_day$price)
caiso_day_pdq

#pdq: (1,1,1)

caiso_day_arima <- arima(caiso_ts_day, order = c(1,1,1))
caiso_day_arima

forecast_caiso_day <- forecast(caiso_day_arima, h = 365) #365 days = 1 year
plot(forecast_caiso_day)

caiso_day_forecast_mean <- forecast_caiso_day$mean
caiso_day_forecast_lower <- forecast_caiso_day$lower
caiso_day_forecast_upper <- forecast_caiso_day$upper

date_seq <- seq(ymd('2019-01-01'),ymd('2019-12-31'), by = 'days')

caiso_forecast_df <- data.frame(date_seq,
                                caiso_day_forecast_mean, 
                                caiso_day_forecast_lower, 
                                caiso_day_forecast_upper)

caiso_forecast_df_ed <- caiso_forecast_df %>% 
  dplyr::select(date_seq, caiso_day_forecast_mean, X95., X95..1)

colnames(caiso_forecast_df_ed) <- c("Date", "price", "lower", "upper")

caiso_day_complete <- rbind.fill(caiso_day, caiso_forecast_df_ed)

caiso_day_complete$Date <- as.Date(caiso_day_complete$Date,
                                  format="%m/%d/%Y")

#date breaks

breaks_qtr = seq(from = min(caiso_day_complete$Date), to = max(caiso_day_complete$Date), by = "3 months")
labels_year = format(seq(from = min(caiso_day_complete$Date), to = max(caiso_day_complete$Date), by = "1 year"), "%Y")
labs = c(sapply(labels_year, function(x) {
    c(x, rep("", 3))
    }))


 ggplot(caiso_day_complete, aes(x= Date, y = price)) +
       geom_line() +
       geom_ribbon(aes(ymin = lower, ymax= upper),
                   alpha = 0.1,
                   fill = "coral") +
       ylab("Price ($/Megawatt-Hour)") +
       xlab("") +
       labs(title = "Historic and Forecasted California Wholesale Prices (2015 - 2020)") +
       theme_classic() +
       theme(plot.title = element_text(hjust = 0.5, 
                                       size = 20),
             axis.text = element_text(size = 12)) +
       scale_x_date(labels = labs, breaks = breaks_qtr, name = "Year")
     

  
       

```


```{r explore hourly data in a day}

caiso_day <- read_csv("caiso_single.csv") %>% 
  dplyr::mutate(hour = (hour(datetime))) %>% 
  dplyr::group_by(hour) %>% 
    dplyr::summarise(
      mean(price)
    )

plot(caiso_day)

```

```{r explore daily data}

caiso_daily <- read_csv("caiso_single.csv")

caiso_daily$datetime <- as.POSIXct(caiso_daily$datetime,
                         format="%m/%d/%Y %H:%M")

caiso_daily_ed <- caiso_daily %>%
  dplyr::mutate(key = "caiso") %>% 
  as_tsibble(key = id(key), index = datetime) %>% 
  index_by(date = floor_date(datetime, "hour")) %>% 
  summarise(price = mean(price))

plot(caiso_daily)

```

```{r explore monthly data}

caiso_monthly <- read_csv("caiso_single.csv") %>% 
  dplyr::mutate(month = (month(datetime))) %>% 
  dplyr::group_by(month) %>% 
    dplyr::summarise(
      mean(price)
    )

```



```{r filter by datetime message=FALSE}

caiso_hourly <- read_csv("caiso_hourly.csv")

caiso_jan <- caiso_hourly %>% 
  dplyr::filter(datetime < ymd_hms("2018-02-01 00:00:00"))

```



##Energy Data

```{r energy_data}

#Renewable production data

renew_prod <- read.csv("renewable_gen_info.csv")

#Renewable project meta data

renew_met <- read.csv("renewable_metadata.csv")

#PPA Prices 
ppa_price <- seq(19,35, by = 1)



```

```{r reformat energy data}

solar1 <- renew_prod %>% 
  dplyr::select(solar1, Month, Day, Hour) %>% 
  dplyr::mutate(project_name = "solar1") %>% 
  dplyr::rename(production = solar1)

solar2 <- renew_prod %>% 
  dplyr::select(solar2, Month, Day, Hour) %>% 
  dplyr::mutate(project_name = "solar2")%>% 
  dplyr::rename(production = solar2)

solar3 <- renew_prod %>% 
  dplyr::select(solar3, Month, Day, Hour) %>% 
  dplyr::mutate(project_name = "solar3")%>% 
  dplyr::rename(production = solar3)

wind1 <- renew_prod %>% 
  dplyr::select(wind1, Month, Day, Hour) %>% 
  dplyr::mutate(project_name = "wind1")%>% 
  dplyr::rename(production = wind1)

wind2 <- renew_prod %>% 
  dplyr::select(wind2, Month, Day, Hour) %>% 
  dplyr::mutate(project_name = "wind2")%>% 
  dplyr::rename(production = wind2)

renew_prod_final <- rbind(solar1, solar2, solar3, wind1, wind2)

write.csv(renew_prod_final, "renew_prod_final.csv")

```


##Revenue Model

$Revenue = Production (kWh) \times Wholesale Price (\$/kWh)$
$Cost = Production (kWh) \times PPA Price (\$kWh)$

